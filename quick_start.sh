#!/bin/bash

# ๐ค DETECT Manipulations Bot - ะัััััะน ะทะฐะฟััะบ
# ะะฒัะพั: Yusufbek
# ะะตััะธั: 2.1

echo "๐ DETECT Manipulations Bot v2.1"
echo "=================================="
echo ""

# ะัะพะฒะตัะบะฐ Python
if ! command -v python3.11 &> /dev/null; then
    echo "โ Python 3.11 ะฝะต ะฝะฐะนะดะตะฝ. ะฃััะฐะฝะพะฒะธัะต Python 3.11+"
    exit 1
fi

# ะัะพะฒะตัะบะฐ ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั
if [ ! -d ".venv" ]; then
    echo "๐ง ะกะพะทะดะฐะฝะธะต ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั..."
    python3.11 -m venv .venv
fi

# ะะบัะธะฒะฐัะธั ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั
echo "๐ง ะะบัะธะฒะฐัะธั ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั..."
source .venv/bin/activate

# ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
echo "๐ฆ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน..."
pip install --upgrade pip
pip install -r requirements.txt

# ะัะพะฒะตัะบะฐ ะบะพะฝัะธะณััะฐัะธะธ
if [ ! -f "config.py" ]; then
    echo "โ ะคะฐะนะป config.py ะฝะต ะฝะฐะนะดะตะฝ"
    echo "ะกะบะพะฟะธััะนัะต config.prod.py ะฒ config.py ะธ ะฝะฐัััะพะนัะต"
    exit 1
fi

# ะกะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะน
mkdir -p logs

# ะััะฐะฝะพะฒะบะฐ ะฟัะตะดัะดััะธั ัะบะทะตะผะฟะปััะพะฒ
if [ -f "bot.pid" ]; then
    echo "๐ ะััะฐะฝะพะฒะบะฐ ะฟัะตะดัะดััะตะณะพ ัะบะทะตะผะฟะปััะฐ..."
    ./stop.sh
fi

# ะขะตััะธัะพะฒะฐะฝะธะต API
echo "๐งช ะขะตััะธัะพะฒะฐะฝะธะต API..."
python test_api.py

if [ $? -eq 0 ]; then
    echo "โ API ัะตัั ะฟัะพัะตะป ััะฟะตัะฝะพ"
else
    echo "โ๏ธ API ัะตัั ะฝะต ะฟัะพัะตะป, ะฝะพ ะฟัะพะดะพะปะถะฐะตะผ..."
fi

# ะะฐะฟััะบ ะฑะพัะฐ
echo "๐ ะะฐะฟััะบ ะฑะพัะฐ..."
echo "๐ ะะพะณะธ: logs/bot.log"
echo "๐ ะััะฐะฝะพะฒะบะฐ: ./stop.sh"
echo "๐ ะกัะฐััั: ./status.sh"
echo ""

# ะะฐะฟััะบ ะฒ ัะพะฝะพะฒะพะผ ัะตะถะธะผะต
nohup python main.py > logs/bot.log 2>&1 &
echo $! > bot.pid

echo "โ ะะพั ะทะฐะฟััะตะฝ ั PID: $(cat bot.pid)"
echo "โฐ ะฃะฒะตะดะพะผะปะตะฝะธั: ะบะฐะถะดัะต 2 ะผะธะฝััั"
echo "๐ฏ ะะพะฝะธัะพัะธะฝะณ: 10 ะบัะธะฟัะพะฟะฐั"
echo "๐ฐ ะััะพัะฝะธะบ: ัะตะฐะปัะฝัะต ัะตะฝั ะธะท ััะฐะบะฐะฝะฐ"
echo ""
echo "๐ฑ ะัะพะฒะตัััะต Telegram ะฑะพัะฐ!"
echo "๐ ะะพะณะธ: tail -f logs/bot.log"
